pipeline {
  agent any

  options {
    buildDiscarder(logRotator(numToKeepStr: '60', artifactNumToKeepStr: '2'))
  }

  triggers {
    cron 'H 23 * * *'
  }

  stages {
    stage('build') {
      agent {
        dockerfile {
          dir '.'
          filename 'build/Dockerfile'
          reuseNode true
        }
      }
      steps {
        script {
          maven cmd: "clean verify -DSKIP_UNIT_TESTS=false --settings maven/config/settings.xml"
          def build = load 'build/build.groovy'
          build.mavenIssues()
          build.collectJunit()
          archiveArtifacts 'ch.ivyteam.smart.p2/target/*.zip'
        }
      }
    }

    stage('deploy') {
      when { expression { isReleasingBranch() } }
      steps {
        script {
          def p2Name = 'ch.ivyteam.smart.p2'
          def p2Project = p2Name + '/target/'
          def p2RepoZip = findFiles glob: p2Project + '/*.zip'
          def version = p2RepoZip[0].name.replace(p2Name, '').replace('SNAPSHOT.zip', '').replace('-', '')
          def repo = deployP2Repo(srcDir: p2Project + 'repository/', name: 'smart-core', version: version)
          echo "p2 repository available under ${repo.httpUrl}"
          currentBuild.description = "<a href='${repo.httpUrl}'>p2-repo</a>"
        }
      }
    }
  }
}
